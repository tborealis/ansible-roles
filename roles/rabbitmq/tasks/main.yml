---
- name: Add key for RabbitMQ repository
  ansible.builtin.apt_key:
    data: "{{ lookup('file', 'rabbitmq-repo.asc') }}"
    state: present

- name: Add RabbitMQ repository
  ansible.builtin.apt_repository:
    repo: deb https://www.rabbitmq.com/debian/ testing main
    state: present

- name: Install RabbitMQ
  ansible.builtin.apt:
    pkg: rabbitmq-server
    state: present
    update_cache: yes
    cache_valid_time: 3600

- name: Install RabbitMQ management plugin
  community.rabbitmq.rabbitmq_plugin:
    names: rabbitmq_management
    state: enabled

- name: Remove guest user
  community.rabbitmq.rabbitmq_user:
    user: guest
    state: absent

- name: Create admin user
  community.rabbitmq.rabbitmq_user:
    user: admin
    password: {{ rabbitmq_admin_password }}
    tags: administrator
    vhost: /
    configure_priv: .*
    read_priv: .*
    write_priv: .*
