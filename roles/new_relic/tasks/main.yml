---
- name: Add repo key
  ansible.builtin.copy:
    src: newrelic-repo.gpg
    dest: /usr/share/keyrings/newrelic-repo.gpg
    owner: root
    group: root
    mode: 0644

- name: Add New Relic repo
  ansible.builtin.apt_repository:
    repo: "deb [signed-by=/usr/share/keyrings/newrelic-repo.gpg] https://apt.newrelic.com/debian/ newrelic non-free"

- name: Install New Relic
  ansible.builtin.apt:
    pkg: newrelic-php5
    state: present
    update_cache: yes
    cache_valid_time: 3600
  notify: restart php-fpm

- name: Apply settings
  ansible.builtin.template:
    src: "newrelic.ini.j2"
    dest: "/etc/php/{{ php_version }}/mods-available/newrelic.ini"
    owner: root
    group: root
    mode: 0644
  notify: restart php-fpm
